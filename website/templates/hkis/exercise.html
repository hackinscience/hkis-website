{% extends "hkis/layout.html" %}
{% load hkis_extra %}
{% load i18n static md2 bootstrap4 notifications_tags %}
{% block body %}


{{ answer_form.media }}
<link href="{% static "css/pygments/default.css" %}" rel="stylesheet" type="text/css" />
<div class="container">
  {% if next_id %}
  <div class="float-right">
    <a class="btn btn-primary" href="{% url "exercise" next_id %}">
      next â†’
    </a>
  </div>
  {% endif %}
  <div style="margin-bottom: 25px;">
  {{ object.wording|markdown:"fenced-code-blocks"|trash_fix_code_in_a }}
  </div>

  <div class="row">
    <div class="col-md-8">
      <h2>Your Code</h2>
      <form action="/api/answers/" method="post" onsubmit="document.getElementById('submit_answer').setAttribute('disabled', true); AJAXSubmit(this); return false;">{% csrf_token %}
          {% for field in answer_form %}
          <div class="fieldWrapper">
              {{ field }}
          </div>
          {% endfor %}
          <button id="submit_answer" class="btn btn-primary" type="submit">Submit your code</button>
      </form>
    </div>
    <div class="col-md-4">
      <h2>Results</h2>
      <div id="answers-result" class="result">
        <table id="answer-table" class="table">
          {% for answer in answers %}
          <tr><td id="td-{{ answer.id }}">
          {% if not answer.is_corrected %}
            <img src="{% static "img/loading_anim.gif" %}" height=30> Waiting for correction
          {% else %}
            <pre>{{ answer.correction_message }}</pre>
          {% endif %}
          </td></tr>
          {% endfor %}
        </table>
      </div>
    </div>
  </div>
</div>
{% autoescape off %}
<script src="{% static 'notifications/notify.js' %}" type="text/javascript"></script>
<script>
  function fill_answer(data) {
      var result = document.getElementById("answers-result");
      if (!result || data.unread_count == 0)
          return;
      for (var i=data.unread_list.length - 1; i >= 0; i--) {
          var msg = data.unread_list[i];
          if (msg.actor_object_id != "{{ object.id }}")
              continue;
          var elem = document.getElementById("td-".concat(msg.target_object_id));
          if (elem) {
              if (msg.description != "") {
                  elem.innerHTML = "<pre>" + msg.description + "</pre>";
              }
          } else {
              var answer_table = document.getElementById("answer-table");
              var html = '<tr><td id="td-'.concat(msg.target_object_id).concat('"><img src="{% static "img/loading_anim.gif" %}" height=30> Waiting for correction</td> </tr>');
              if ($("#answer-table tr:first").length)
                  $("#answer-table tr:first").before(html);
              else
                  $("#answer-table").append(html);
          }
          document.getElementById('submit_answer').removeAttribute('disabled');
          var xhttp = new XMLHttpRequest();
          xhttp.open("GET", "/inbox/notifications/delete/" + msg.slug + "/", true);
          xhttp.send();
    }
}
</script>
{% register_notify_callbacks callbacks='fill_answer' refresh_period='3' fetch='50' %}
{% endautoescape %}
{% endblock %}
