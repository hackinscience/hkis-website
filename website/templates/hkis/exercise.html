{% extends "hkis/layout.html" %}
{% load hkis_extra %}
{% load i18n static md2 bootstrap4 %}
{% block body %}


{{ answer_form.media }}
<link href="{% static "css/pygments/default.css" %}" rel="stylesheet" type="text/css" />
<div class="container">
  {% if next_id %}
  <div class="float-right">
    <a class="btn btn-primary" href="{% url "exercise" next_id %}">
      next →
    </a>
  </div>
  {% endif %}
  <div style="margin-bottom: 25px;">
  {{ object.wording|markdown:"fenced-code-blocks"|trash_fix_code_in_a }}
  </div>

  <div class="row">
    <div class="col-md-8">
      <h2>Your Code</h2>
      <form action="/api/answers/" method="post" onsubmit="document.getElementById('submit_answer').setAttribute('disabled', true); AJAXSubmit(this); return false;">{% csrf_token %}
          {% for field in answer_form %}
          <div class="fieldWrapper">
              {{ field }}
          </div>
          {% endfor %}
          <button id="submit_answer" class="btn btn-primary" type="submit">Submit your code</button>
      </form>
    </div>
    <div class="col-md-4">
      <h2>Results</h2>
      <div id="answers-result" class="result">
        <table id="answer-table" class="table">
          {% for answer in answers %}
          <tr><td id="td-{{ answer.id }}">
          {% if not answer.is_corrected %}
            <img src="{% static "img/loading_anim.gif" %}" height=30> Waiting for correction
          {% else %}
            <pre>{{ answer.correction_message }}</pre>
          {% endif %}
          </td></tr>
          {% endfor %}
        </table>
      </div>
    </div>
  </div>
</div>
{% autoescape off %}
<script>

(function() {
    function fill_answer(answer_id, is_corrected, message) {
        var result = document.getElementById("answers-result");
        if (!result)
            return;
        var elem = document.getElementById("td-".concat(answer_id));
        if (!elem) {
            var answer_table = document.getElementById("answer-table");
            var html = '<tr><td id="td-'.concat(answer_id).concat('">…</td> </tr>');
            if ($("#answer-table tr:first").length)
                $("#answer-table tr:first").before(html);
            else
                $("#answer-table").append(html);
            elem = document.getElementById("td-".concat(answer_id));
        }
        if (is_corrected) {
            elem.innerHTML = "<pre>" + message + "</pre>";
            document.getElementById('submit_answer').removeAttribute('disabled');
        } else {
            elem.innerHTML = '<img src="{% static "img/loading_anim.gif" %}" height=30> Waiting for correction';
        }
    }

    var chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/answers/' + {{ user.id }} + '/' + {{object.id}} + '/');

    chatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        console.log("WebSocket recv:", data);
        fill_answer(data.answer, data.is_corrected, data.message);
    };
})();
</script>
{% endautoescape %}
{% endblock %}
